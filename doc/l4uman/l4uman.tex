% Permission to make digital/hard copy of part or all of this work for
% personal or classroom use is granted without fee provided that copies
% are not made or distributed for profit or commercial advantage, the
% copyright notice, the title of the publication and its date appear, and
% notice is given that copying is by permission of the authors. To copy
% otherwise, to republish, to post on servers, or to redistribute to lists
% requires prior specific permission and/or a fee.
%
% Copyright (C) 1998 by Gernot Heiser, The University of New South Wales.


\documentclass[a4paper,11pt,twoside,dvips]{report}
\usepackage{Bkit}
\usepackage{subfigure}
\usepackage{epsfig}
\usepackage{rcs}
\usepackage{times}
\usepackage{cite}
\usepackage{changebar}

\RCS$Revision: 1.16 $
\RCS$Date: 1999/08/11 02:33:34 $

\sloppy

\title{\Huge L4 User Manual\\[20pt]
       \LARGE Version \RCSRevision}

\newcommand{\Tilde}{\raisebox{-0.6ex}{\~{}}}
\author{Alan Au, Gernot Heiser\\
       {\normalsize School of Computer Science and Engineering}\\
       {\normalsize The University of New South Wales}\\
       {\normalsize Sydney 2052, Australia}\\
       {\normalsize \{alanau,gernot\}@cse.unsw.edu.au}}

\date{\RCSDate\\[1ex] Version 1.5 is identical to UNSW-CSE-TR-9801 of June 1998\\
	\vfill\sf
	\epsfig{file=eps/unicrest-screen.eps,height=25mm}\\[2ex]
	School of Computer Science and Engineering\\
	The University of New South Wales\\
	Sydney 2052, Australia \vspace{-10mm}}

\newcounter{example}[chapter]
\newcommand{\example}[1]{\addtocounter{example}{1}
			\underline{\emph{Example \thechapter.\theexample}}
			 - #1 \\}
 
\newcommand{\micro}{$\mu$}
\renewcommand{\textfraction}{0.05}
\renewcommand{\topfraction}{0.95}
\renewcommand{\bottomfraction}{0.95}
\newcommand{\sigz}{\mbox{$\sigma_{0}$}}



\newcommand{\smaller}[1]{{\mathchoice
           {\raisebox{1pt}{$\scriptstyle #1$}}
           {\raisebox{1pt}{$\scriptstyle #1$}}
           {\raisebox{0.5pt}{$\scriptscriptstyle #1$}}
           {\raisebox{0.5pt}{$\scriptscriptstyle #1$}}
}}
\newcommand{\smallerlow}[1]{{\mathchoice
           {\mbox{$\scriptstyle \,#1\,$}}
           {\mbox{$\scriptstyle \,#1\,$}}
           {\mbox{$\scriptscriptstyle \,#1\,$}}
           {\mbox{$\scriptscriptstyle \,#1\,$}}
}}
\newcommand{\IN}{\smaller{\in}}
\newcommand{\LT}{\smaller{<}}
\newcommand{\LE}{\smaller{\le}}
\newcommand{\GT}{\smaller{>}}
\newcommand{\GE}{\smaller{\ge}}
\newcommand{\EQ}{\smaller{=}}
\newcommand{\NE}{\smaller{\neq}}
\newcommand{\CUP}{\smallerlow{\cup}}
\newcommand{\PLUS}{\smaller{+}}

\newcommand{\nil}{--nil--\ }
\newcommand{\never}{--never--\ }
\newcommand{\undef}{$\sim$}

\newcommand{\stdtabs}{\sf\=XX\=XX\=XX\=XX\=XX\=XX\=XX\=Xx\=Xx\=Xx\=Xx\=XXXXX\=\kill\+\+\\}

\newcommand{\alg}[1]
 {{\noindent
 \begin{minipage}{\textwidth}
 \begin{tabbing}\stdtabs\+ #1 \end{tabbing}
 \end{minipage}}}

\newcommand{\asmtabs}{\sf\=XYYXXXX\=XYYXXXX\=XXXXX\=XXXXXXXXXXXX\=\kill\+\+\\[-5pt]}

\newcommand{\asm}[1]
 {{\noindent\tt
 \begin{minipage}{\textwidth}
 \begin{tabbing}\asmtabs #1 \end{tabbing}
 \end{minipage}}}


\newcommand{\WHILE}{{\bf while}\ }
\newcommand{\UNTIL}{{\bf until}\ }
\newcommand{\DO}{{\bf do}\ \+}
\newcommand{\OD}{{\<\bf od}\ \-}
\newcommand{\IF}{{\bf if}\ \+}
\newcommand{\FI}{{\<\<\<\bf fi}\ \-\-\-}
\newcommand{\THEN}{{\bf then}\ \>\>\+\+}
\newcommand{\ELSE}{{\<\<\bf else}\>\>}
\newcommand{\ELIF}{{\<\<\<\bf elif}\ \-\-}

\newcommand{\While}{{\bf while}\ }
\newcommand{\Until}{{\bf until}\ }
\newcommand{\Do}{{\bf do}\ }
\newcommand{\Od}{{\bf od}\ }
\newcommand{\If}{{\bf if}\ }
\newcommand{\Fi}{{\bf fi}\ }
\newcommand{\Then}{{\bf then}\ }


\newcommand{\dd}{D}
\newcommand{\dci}{d_{c_i}}
\newcommand{\Dci}{d_{c_i,\dot{v}}}
\newcommand{\dv}{V}
\newcommand{\ddv}{V'}
\newcommand{\vci}{v_{c_i}}
\newcommand{\cj}{c_j}

\newcommand{\dw}{\mbox{\it write}}
\newcommand{\ndw}{\overline{\mbox{\it write}}}

\newcommand{\allj}{\forall_{j\neq i}:\ \alias\mapsto\cj}

\newcommand{\rdy}{\ \Box}
\newcommand{\sync}{\ \Box}

\newcommand{\high}{\mbox{\rule{0pt}{\baselineskip}}}
\newcommand{\High}{\mbox{$\frac{\high}{\high}$}}

\newlength{\Xlen}
\settowidth{\Xlen}{0}
\newcommand{\X}{\makebox[\Xlen]{}}


\newlength{\Up}\setlength{\Up}{-\baselineskip}
\newlength{\Upp}\setlength{\Upp}{\Up}\addtolength{\Upp}{\Upp}
\newlength{\Upppp}\setlength{\Upppp}{\Upp}\addtolength{\Upppp}{\Upppp}

\newlength{\PPre}
\newlength{\Params}

\newif\ifintel
\intelfalse
\newlength{\scindent}
\setlength{\scindent}{140pt}

\newcommand{\generalsc}[1]{\intelfalse\setlength{\scindent}{#1}}
\newcommand{\intelsc}[1]{\inteltrue\setlength{\scindent}{#1}}

\newcommand{\sccode}[1]{\global\def\syscode{#1}}


\newcommand{\scin}[1]{(#1)\ }
\newcommand{\scout}[1]{{\Large\ $\rightarrow$\ } (#1)\\}





\newcommand{\EAX}[2]{{\em #1}&{\footnotesize EAX}&&{\footnotesize EAX}&{\em #2}\\}
\newcommand{\EBX}[2]{{\em #1}&{\footnotesize EBX}&&{\footnotesize EBX}&{\em #2}\\}
\newcommand{\ECX}[2]{{\em #1}&{\footnotesize ECX}&&{\footnotesize ECX}&{\em #2}\\}
\newcommand{\EDX}[2]{{\em #1}&{\footnotesize EDX}&&{\footnotesize EDX}&{\em #2}\\}
\newcommand{\ESI}[2]{{\em #1}&{\footnotesize ESI}&&{\footnotesize ESI}&{\em #2}\\}
\newcommand{\EDI}[2]{{\em #1}&{\footnotesize EDI}&&{\footnotesize EDI}&{\em #2}\\}
\newcommand{\EBP}[2]{{\em #1}&{\footnotesize EBP}&&{\footnotesize EBP}&{\em #2}\\}
\newcommand{\EAL}[2]{{\em #1}&{\footnotesize  AL}&&{\footnotesize EAX}&{\em #2}\\}
\newcommand{\EAH}[1]{{\em #1}&{\footnotesize  AH}&&&\\}
\newcommand{\EBL}[2]{{\em #1}&{\footnotesize  BL}&&{\footnotesize EBX}&{\em #2}\\}
\newcommand{\BH}[1]{{\em #1}&{\footnotesize  BH}&&&\\}
\newcommand{\ECL}[2]{{\em #1}&{\footnotesize  CL}&&{\footnotesize ECX}&{\em #2}\\}
\newcommand{\CH}[1]{{\em #1}&{\footnotesize  CH}&&&\\}

\newcommand{\EAXX}[3]{{\em #1}&{\footnotesize EAX}&&{\footnotesize EAX}&{\em #2}&~~{\scriptsize /}~~~{\em #3}\\}
\newcommand{\EBXX}[3]{{\em #1}&{\footnotesize EBX}&&{\footnotesize EBX}&{\em #2}&~~{\scriptsize /}~~~{\em #3}\\}
\newcommand{\ECXX}[3]{{\em #1}&{\footnotesize ECX}&&{\footnotesize ECX}&{\em #2}&~~{\scriptsize /}~~~{\em #3}\\}
\newcommand{\EDXX}[3]{{\em #1}&{\footnotesize EDX}&&{\footnotesize EDX}&{\em #2}&~~{\scriptsize /}~~~{\em #3}\\}
\newcommand{\ESIX}[3]{{\em #1}&{\footnotesize ESI}&&{\footnotesize ESI}&{\em #2}&~~{\scriptsize /}~~~{\em #3}\\}
\newcommand{\EDIX}[3]{{\em #1}&{\footnotesize EDI}&&{\footnotesize EDI}&{\em #2}&~~{\scriptsize /}~~~{\em #3}\\}
\newcommand{\EBPX}[3]{{\em #1}&{\footnotesize EBP}&&{\footnotesize EBP}&{\em #2}&~~{\scriptsize /}~~~{\em #3}\\}

\newcommand{\USP}[2]{{\em #2}&%
\multicolumn{5}{l}{{\footnotesize $\langle$SP#1$\rangle$}}\\}

\newcommand{\Or}{\ {\scriptsize /}\ \ }

\newenvironment{param}[1]
{%
\setlength{\Params}{\textwidth}\addtolength{\Params}{-140pt}%
\par\vspace{5pt}%
\noindent\begin{minipage}{\textwidth}
\noindent {\em #1}\\[\Up]%
\noindent\begin{tabular}{@{\hspace*{75pt}}lp{\Params}}%
\hspace*{30pt}&\\[\Up]%
}
{%
\end{tabular}\end{minipage}\par\vspace{5pt}%
}



\newlength{\bboxw}

\newcommand{\Bbox}[2]{\setlength{\bboxw}{#2pt}\addtolength{\bboxw}{\bboxw}%
\addtolength{\bboxw}{#2pt}%
\addtolength{\bboxw}{\bboxw}\addtolength{\bboxw}{\bboxw}\addtolength{\bboxw}{\bboxw}%
\framebox[\bboxw]{{\footnotesize #1\rule[-4pt]{0pt}{14pt}}}%
}

\newenvironment{vwg}{\par\vspace{10pt}%
\noindent\begin{tabular}{llll}\hspace*{80pt}&\hspace*{200pt}\\[\Up]}
{\end{tabular}\par\vspace{10pt}}


\def\registered{{\ooalign{\hfil\raise.07ex\hbox{\sc r}\hfil\crcr\mathhexbox20D}}}

\newcommand{\Pentium}{Pentium$^{\footnotesize\registered}$}

\setlength{\unitlength}{0.5pt}

\newcommand{\repl}{\leftarrow}
\newcommand{\PT}{P}


\renewcommand{\textfraction}{0.05}
\renewcommand{\topfraction}{0.95}
\renewcommand{\bottomfraction}{0.95}

\hyphenation{ca-che}
\hyphenation{bench-mark}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\impnote}[1]{\framebox{\textbf{MIPS Implementation Note:}} #1}
\newcommand{\reg}[1]{\mbox{\textbf{#1}}}
\newcommand{\regs}[3]{{\em #2}&{\footnotesize \reg{#1}}&&{\footnotesize
    \reg{#1}}&{\em #3}\\}
\newcommand{\regx}[4]{{\em #2}&{\footnotesize \reg{#1}}&&{\footnotesize
    \reg{#1}}&{\em #3}&~~{\scriptsize /}~~~{\em #4}\\}

\newcommand{\abox}[2]{\setlength{\bboxw}{#2pt}\addtolength{\bboxw}{\bboxw}%
\addtolength{\bboxw}{\bboxw}\addtolength{\bboxw}{\bboxw}%
\framebox[\bboxw]{{\footnotesize #1\rule[-1ex]{0pt}{4ex}}}}

\newcommand{\bbox}[2]{\setlength{\bboxw}{#2pt}\addtolength{\bboxw}{\bboxw}%
\addtolength{\bboxw}{\bboxw}\addtolength{\bboxw}{\bboxw}%
\framebox[\bboxw]{{\footnotesize #1$_{\ (#2)}$\rule[-1ex]{0pt}{4ex}}}}

\newcommand{\cbox}[3]{\setlength{\bboxw}{#3pt}\addtolength{\bboxw}{\bboxw}%
\addtolength{\bboxw}{\bboxw}\addtolength{\bboxw}{\bboxw}%
\framebox[\bboxw]{{\footnotesize #1$_{\ (#2)}$\rule[-1ex]{0pt}{4ex}}}}

\newenvironment{SC}[1]%
{%
\ifintel\clearpage\markboth{\uppercase{#1}}{\uppercase{#1}}\addcontentsline{toc}{subsection}{#1}\fi%
\vspace*{30pt}\noindent%
\ifintel%
%
{\LARGE\bf #1\\[\Up]}%
\noindent\hspace*{\fill}\begin{tabular}{rl|c|ll@{}l}%
\hspace*{\scindent}&&&&\multicolumn{2}{c}{\hspace*{120pt}}\\&&&&\\&&&&\\%
&&{\Large $-$} \reg{AT} 0x\syscode {\Large $\rightarrow$}&&\\[\Upppp]%
\else%
{\Large\bf #1\\[\Up]}%
\noindent\hspace*{\scindent}\begin{tabular}{l}%
\fi%
}%
{%
\end{tabular}\par\vspace{20pt}%
}

\newenvironment{SC*}[1]%
{%
\vspace*{20pt}%
\noindent\begin{minipage}{\textwidth}%
\noindent{\large\sc #1\\}%
\ifintel%
%
\noindent\hspace*{\fill}\begin{tabular}{rl|c|ll}%
\hspace*{180pt}&&&&\hspace*{120pt}\\&&&&\\&&&&\\%
&&{\large $-$} \reg{AT} 0x\syscode {\Large $\rightarrow$}&&\\[\Upppp]%
\else%
\noindent\hspace*{\scindent}\begin{tabular}{l}%
\fi%
}%
{%
\end{tabular}\end{minipage}\par\vspace{20pt}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\pagestyle{headings}

\pagenumbering{roman}
\begin{document}

\thispagestyle{empty}
\setcounter{page}{1}


\maketitle

\setcounter{page}{2}
\pagestyle{headings}
\thispagestyle{empty}

\cleardoublepage

\begin{abstract}
\thispagestyle{headings} \setcounter{page}{3} This document is a user
manual for the L4 \micro-kernel. It gives an introduction to the main
concepts and features of L4, and explains their use by a number of
examples. The manual is generally platform independent, however,
examples are based on the C interface for L4/MIPS. Actual system call C
bindings and data formats differ slightly on other platforms.

This document supplements, rather than replaces, the L4 Reference
Manual, and anyone intending to write an applications on top of L4
should obtain the L4 Reference Manual for their particular platform.

\vspace*{\fill}
{\small
\noindent\hrulefill\\
%
Permission to make digital/hard copy of part or all of this work for
personal or classroom use is granted without fee provided that copies
are not made or distributed for profit or commercial advantage, the
copyright notice, the title of the publication and its date appear, and
notice is given that copying is by permission of the authors. To copy
otherwise, to republish, to post on servers, or to redistribute to lists
requires prior specific permission and/or a fee.\\[2ex]
%
Copyright \copyright 1998 by Gernot Heiser, The University of New South Wales.
}
\end{abstract}
\clearpage
\setcounter{page}{4}
\cleardoublepage

\setcounter{page}{5}
\section*{Preface}

This manual grew out of lecture notes for a course on Advanced Operating
Systems given by Gernot Heiser at UNSW in July--November 1997. In that
course students had to build a small operating system on top of L4/MIPS
which had previously been developed at UNSW by Kevin Elphinstone with
lots of help from Jochen Liedtke. We would like to thank the 44 students
of that course (one of whom was Alan Au) for their interest and
patience, as well as for their questions which prompted the lecturer to
write and provide further documentation. We would further like to thank
Jochen Liedtke for providing the L4 specification and the original
reference manual, Kevin Elphinstone for the MIPS implementation as well
as for explaining L4's idiosyncrasies, the OS group at the Technical
University of Dresden under Herrman H\"artig for example code, C
bindings and manual pages, and Jerry Vochteloo and many others for their
contributions.

It is expected that this manual will continue to grow as more people are
learning to use L4, and consequently discover shortcomings of the
documentation.  We welcome comments, corrections and enhancements and
will try to incorporate them quickly into the manual.  The latest
version of this manual (as well as of the L4/MIPS Reference
Manual~\cite{Elphinstone_HL:L4rm}) are available from
\textsf{http://www.cse.unsw.edu.au/{\Tilde}disy}.

\cleardoublepage
\setcounter{page}{7}
\tableofcontents

\cleardoublepage
\setcounter{page}{1}
\pagenumbering{arabic}
\include{intro}

\include{l4ipc}		% updated 11/8/99

\include{l4nonipc}	% updated 11/8/99

\include{l4use}

%\include{bib}
\bibliographystyle{alpha}
\bibliography{defs,os,dist}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\end{document}

% 
%%% Local Variables: %%%
%%% mode: latex %%%
%%% End: %%%
